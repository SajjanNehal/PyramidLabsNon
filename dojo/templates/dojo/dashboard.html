{% extends "base.html" %}
{% load static from staticfiles %}
{% block add_styles %}
    .chart {height: 300px}
    .status .panel {min-height: 140px;background-color: #f5f5f5;}
    #punchcard {height: 350px}
{% endblock %}
{% block content %}
    <!--
    {% if request.user.is_superuser %}
        <h3>Team Dashboard</h3>
    {% else %}
        <h3>Dashboard for {{ request.user.get_full_name }}</h3>
    {% endif %}
  -->
    <div class="row">
        <!-- /.col-lg-6 -->
        <div class="col-lg-6 col-sm-6 col-sm-offset-3 col-lg-offset-3 ip-address-box text-center">
            <form class="form-horizontal">
              <div class="form-group">
                  <div class="col-sm-12"><input type="text" class="form-control" placeholder="IP address"></div>
              </div>
              <button type="button" class="btn btn-yellow" data-toggle="modal" data-target="#myModal">Quick Scan</button>
              <select class="btn btn-green" id="sel1">
                <option>Scheduled Scan</option>
                <option>Every Day</option>
                <option>Weekly</option>
                <option>Bi-Weekly</option>
                <option>Monthly</option>
              </select>
              <br><br>
            </form>
            <!-- /.form -->
        </div>
        <!-- /.col-lg-6 -->
    </div>
    <div class="row">
        <div class="col-lg-3">
            <div class="panel panel-default">
              <div class="panel-body">
                  <h2><small><sup>$</sup></small> 23,125</h2>
                  <h4><small>Deposites: </small>$ 10,000</h4>
                  <h4 class="text-primary">+5.2% ($456)</h4>
              </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-lg-6">
            <div class="panel panel-default">
                <div class="panel-heading">
                    Historical Finding Severity
                </div>
                <!-- /.panel-heading -->
                <div class="panel-body">
                    <canvas id="chart-area"></canvas>
                </div>
                <!-- /.panel-body -->
            </div>
            <!-- /.panel -->
        </div>
        <div class="col-lg-6">
            <div class="panel panel-default">
                <div class="panel-heading">
                    Reported Finding Severity by Month
                </div>
                <!-- /.panel-heading -->
                <div class="panel-body">
                    <div class="chart" id="line-chart"></div>
                </div>
                <!-- /.panel-body -->
            </div>
            <!-- /.panel -->
        </div>
    </div>
    <div class="row">
        {% if punchcard %}
            <div class="col-lg-12">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        Weekly activity, displayed by day, of findings you reported.*
                    </div>
                    <div class="panel-body">
                        <div class="chart" id="punchcard"></div>
                        <p class="text-center text-muted small">Week begins on date displayed.</p>
                        <p>
                            <br/>
                            <span class="text-muted small">* Weeks are only displayed if findings are available.</span>
                        </p>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

<!-- Modal of Quick Scan -->
<div class="modal fade" id="myModal" role="dialog">
    <div class="modal-dialog modal-sm">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Quick scan</h4>
        </div>
        <div class="modal-body">
          <p class="modal-enabled">
            Enabled
              &nbsp; &nbsp;
              <label class="switch">
                  <input type="checkbox" checked><span class="slider round"></span>
              </label>
              &nbsp; &nbsp;
            Disabled
          </p>
          <p>When it is enabled. It is doing an autonomous quick partial scan every day at 2pm.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-success" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
</div>


{% endblock %}
{% block postscript %}
    <!-- Flot Charts JavaScript -->
    <script src="{% static "flot/excanvas.min.js" %}"></script>
    <script src="{% static "flot/jquery.flot.js" %}"></script>
    <script src="{% static "flot/jquery.flot.pie.js" %}"></script>
    <script src="{% static "flot/jquery.flot.time.js" %}"></script>
    <script src="{% static "flot.tooltip/js/jquery.flot.tooltip.min.js" %}"></script>
    <script src="{% static "flot/jquery.flot.stack.js" %}"></script>
    <script src="{% static "flot/jquery.flot.resize.js" %}"></script>
    {% if punchcard %}
        <script src="{% static "JUMFlot/JUMFlot.min.js" %}"></script>
        <script src="{% static "JUMFlot/jquery.flot.mouse.js" %}"></script>
        <script src="{% static "JUMFlot/jquery.flot.bubbles.js" %}"></script>
    {% endif %}
    <script>
    $(document).ready(function(){
        $('[data-toggle="popover"]').popover();
    });
    </script>
    <script src="{% static "dojo/js/Chart.bundle.min.js" %}"></script>
    <script src="{% static "dojo/js/utils.js" %}"></script>
	<script>
		var randomScalingFactor = function() {
			return Math.round(Math.random() * 100);
		};

		var config = {
			type: 'doughnut',
			data: {
				datasets: [{
					data: [
						randomScalingFactor(),
						randomScalingFactor(),
						randomScalingFactor(),
						randomScalingFactor(),
					],
					backgroundColor: [
						window.chartColors.red,
						window.chartColors.orange,
						window.chartColors.yellow,
						window.chartColors.blue,
					],
					label: 'Dataset 1'
				}],
				labels: [
					'Critical',
					'High',
					'Medium',
					'Low',
				]
			},
			options: {
				responsive: true,
				legend: {
					position: 'top',
                    labels: {
					    fontColor: '#00FF24',
                    }
				},
				title: {
					display: false,
					text: 'Title Here'
				},
				animation: {
					animateScale: true,
					animateRotate: true
				}
			}
		};

		window.onload = function() {
			var ctx = document.getElementById('chart-area').getContext('2d');
			window.myDoughnut = new Chart(ctx, config);
		};

		document.getElementById('randomizeData').addEventListener('click', function() {
			config.data.datasets.forEach(function(dataset) {
				dataset.data = dataset.data.map(function() {
					return randomScalingFactor();
				});
			});

			window.myDoughnut.update();
		});

		var colorNames = Object.keys(window.chartColors);
		document.getElementById('addDataset').addEventListener('click', function() {
			var newDataset = {
				backgroundColor: [],
				data: [],
				label: 'New dataset ' + config.data.datasets.length,
			};

			for (var index = 0; index < config.data.labels.length; ++index) {
				newDataset.data.push(randomScalingFactor());

				var colorName = colorNames[index % colorNames.length];
				var newColor = window.chartColors[colorName];
				newDataset.backgroundColor.push(newColor);
			}

			config.data.datasets.push(newDataset);
			window.myDoughnut.update();
		});

		document.getElementById('addData').addEventListener('click', function() {
			if (config.data.datasets.length > 0) {
				config.data.labels.push('data #' + config.data.labels.length);

				var colorName = colorNames[config.data.datasets[0].data.length % colorNames.length];
				var newColor = window.chartColors[colorName];

				config.data.datasets.forEach(function(dataset) {
					dataset.data.push(randomScalingFactor());
					dataset.backgroundColor.push(newColor);
				});

				window.myDoughnut.update();
			}
		});

		document.getElementById('removeDataset').addEventListener('click', function() {
			config.data.datasets.splice(0, 1);
			window.myDoughnut.update();
		});

		document.getElementById('removeData').addEventListener('click', function() {
			config.data.labels.splice(-1, 1); // remove the label first

			config.data.datasets.forEach(function(dataset) {
				dataset.data.pop();
				dataset.backgroundColor.pop();
			});

			window.myDoughnut.update();
		});
	</script>
    <script>
        var highest_count = {{ highest_count }};
        $(function () {
            var options = {
                xaxes: [{
                    mode: 'time'
                }],
                yaxes: [{
                    min: 0
                }],
                series: {
                    lines: {
                        show: true
                    },
                    points: {
                        show: true
                    }
                },
                grid: {
                    hoverable: true,
                    borderWidth: 1,
                    borderColor: '#00FF24',

                },
                tooltip: true,
            };
            chart_div();
            severity_pie();

            function chart_div() {
                var critical = [],
                        high = [],
                        medium = [],
                        low = [];

                {% for month in by_month %}
                    month = {{month|safe}};
                    ttp = new Date(month['y'] + '-01').getTime();
                    critical.push([ttp, month['a']]);
                    high.push([ttp, month['b']]);
                    medium.push([ttp, month['c']]);
                    low.push([ttp, month['d']]);
                {% endfor %}


                var plotObj = $.plot($("#line-chart"), [{
                            data: critical,
                            label: " Critical",
                            color: "#d9534f",
                        }, {
                            data: high,
                            label: " High",
                            color: '#f0ad4e',
                        }, {
                            data: medium,
                            label: " Medium",
                            color: '#f0de28',
                        }, {
                            data: low,
                            label: " Low",
                            color: '#337ab7',
                        }],
                        options);
            }

            function severity_pie() {
                var data = [{
                    label: "Critical",
                    color: "#d9534f",
                    data: {{critical}}
                }, {
                    label: "High",
                    color: "#f0ad4e",
                    data: {{high}}
                }, {
                    label: "Medium",
                    color: "#f0de28",
                    data: {{medium}}
                }, {
                    label: "Low",
                    color: "#337ab7",
                    data: {{low}}
                }, {
                    label: "Informational",
                    color: "#E0E0E0",
                    data: {{info}}
                }];

                var plotObj = $.plot($("#donut-chart"), data, {
                    series: {
                        pie: {
                            innerRadius: 0.5,
                            show: true,
                            radius: 1,
                            label: {
                                show: false,
                                radius: 2 / 3,
                                formatter: function (label, series) {
                                    return '<div style="font-size:8pt;text-align:center;padding:2px;color:#00FF24;z-index:9999;">' + label + '<br/>' + series.data[0][1] + '</div>';

                                },

                            }
                        }
                    },
                    grid: {
                        hoverable: true,
                    },
                });
            }

            {%  if punchcard %}

                punchcard("#punchcard", {{ punchcard|safe }}, {{ ticks|safe }});

            {%  endif %}

        });

    </script>
{% endblock %}
